## Zigbee

ZigBee技术是一种短距离、低功耗的无线通信技术。对于智能家具通信来说恰到好处，符合我对通信的需求

在淘宝购置Zigbee模块时发现Zigbee似乎是一种处理单元，就像是本身就是一块单片机，一块具有无线通信功能的单片机。

由于周边环境基础设备的限制，先买了3块不同型号的开发板（亿佰特的两块E18-MS1PA1-PCB和一块E180-ZG120B）进行Zigbee的学习

学习过程发现，E18相较于E180使用方便，成本较低，打算后续所有Zigbee模块都使用E18，如果云哲或李烨中意E180也可以加入食用，代码差异极小

### AT指令与HEX指令

其实对Zigbee的模块的使用仅限于对它发一些控制指令，即：进入配置模式 -> 配置一堆东西 -> 进入透传模式(充当无线收发器)

HEX指令：HEX就是十六进制，指令传输过程就是传输一个个的十六进制数。比如：55 03 00 16 16

[AT指令](https://so.csdn.net/so/search?q=AT指令&spm=1001.2101.3001.7020)：AT 即Attention，AT 指令用来定义终端设备TE(TerminalEquipment)和移动台MT(Mobile Terminal)之间交互的规则，即当终端设备输入一个后，与之通信的移动台将会回复一个结果，就这样一对一的进行。比如：AT+SEND

AT在代码编写难度上个人感觉略高于HEX而且E18似乎并不支持AT指令

### PAN_ID

​		PAN 的全称为Personal Area Networks，即个域网。每个个域网都有一个独立的ID 号，即称为PAN ID。整个个域网中的所有设备共享同一个PAN ID。Zigbee 设备的PAN ID **可以通过程序预先指定**（E180系列不支持），**也可以在设备运行期间，自动加入**（也就是不预先指定PANID）到一个附近的PAN 中。当PAN ID 为0xFFFF 时，表示该设备可加入环境中存在的任意Zigbee 网络中；否则，当PAN ID 为任意其它值，如0xF53D，则该设备只能加入PAN ID 相同的Zigbee 网络。

一句话简单概括：PANID就是一个局域网的号码，号码一样才能进局域网，对号入座。

### 大小端模式

[大小端模式](https://so.csdn.net/so/search?spm=1001.2101.3001.4498&q=大小端模式&t=&u=)就是数据存储的方式，**了解一下，解解惑，实际项目用不到……**

### 信道

**了解一下，解解惑，实际项目用不到……**

由于ZigBee使用的是免执照的工业科学医疗（ISM）频段，所以ZigBee使用了3个频段，分别为：868MHz（欧洲）、915MHz（美国）、2.4GHz（全球）。

这样，ZigBee共定义了27个物理信道，其中，868MHz频段定义了一个信道；915MHz频段附近定义了10个信道，信道间隔为2MHz；2.4GHz频段定义了16个信道，信道间隔为5MHz。具体信道分配如下表：

| 信道编号：    | 中心频率/MHz | 信道间隔/MHz | 频率上限/MHz | 频率下线/MHz |
| ------------- | ------------ | ------------ | ------------ | ------------ |
| k=0           | 868.3        |              | 868.6        | 868.0        |
| k=1,2,3…10    | 906+2(k-1)   | 2            | 928.0        | 902.0        |
| k=11,12,13…26 | 2401+5(k-11) | 5            | 2483.5       | 2400.0       |

其中，理论上，在868MHz的物理层，数据传输速率为20Kb/s；在915MHz的物理层，数据传输速率为40Kb/s；在2.4GHz的物理层，数据传输速率为250Kb/s。实际上，除掉信道竞争应答和重传等消耗，真正能被应用所利用的速率可能不足100Kb/s，并且余下的速率可能要被临近多个节点和同一个节点的应用瓜分。

### 串口格式

#### 串口的出厂设置

波特率：115200
数据位： 8 位模式
停止位： 1 位模式
校验位： 无
流控制： 无  

#### 三种命令

输入命令：（使用频率最高）
上位机向模组输入的命令帧， 输入时为一个完整的命令帧。  

反馈命令：(用来检验输入数据是否成功，if语句的常客)
模组收到输入命令后向上位机反馈的命令， 每条输入命令都有反馈命令产生。 原则上需
要连续向模组输入一条命令后必须等待反馈命令， 但模组本身对粘连的连续两帧命令进行容
错， 因此可能出现连续输入多条命令后连续反馈多条命令。 反馈命令的等待时间即为模组内
部 CPU 执行时间， 最长可达 10 秒。  

异步命令：（没用到）
模组随机发送给上位机的命令， 该命令可能与输入命令有一定的因果关系， 也有可能没
有关系， 更多的是不确定因素， 因此异步命令可以当做一个随机事件来处理。 

#### 命令帧结构（适用于以上三种命令）(重要)

|  名称  | 帧头 | 帧长度 | 帧载荷       |
| :----: | ---- | ------ | ------------ |
|        | SFD  | LEN    | payload      |
| 字节数 | 1    | 1      | 变长(即不定) |

帧头： 以 0x55 作为命令开头
帧长度： 帧长度即帧载荷长度， 最大值 255。
帧载荷： 帧载荷即串口帧的有效数据（ 含校验） ， 当模组收到**帧载荷字节数与帧长度相等**，即接收完一帧完整的命令帧  

##### 串口帧载荷的构成  

![image-20230113161329753](F:\TyporaMarks\对Zigbee模块的理解和使用.assets\image-20230113161329753.png)

命令类型：
		根据命令的模式和工作机制， 进行分类。 
		输入命令和反馈命令的命令类型从 0x00~0x7F，异步命令的范围是 0x80~0xFF。

命令码：
		命令对应的编码， 长度 1 字节， 每条命令都有唯一的命令编码。 

命令数据：详细请参考《亿佰特ZigBee3.0模组HEX命令标准规范_V1.1.pdf》 
		该命令执行的附带参数， 最小 0 字节， 最大 252 字节。

校验码：
		命令载荷中包含命令类型， 命令编码， 命令数据的全部的 XOR 校验和（BBC算法的计算结果）， 长度 1 字节。 

##### BBC算法

(XOR是异或符号)

校验位为8位数据，其是对其前面的命令类型， 命令编码， 命令数据进行异或校验。
假设命令类型是F3(16进制），命令编码是E2，数据是42 3A，异或校验的工作过程如下：

1：将命令类型， 命令编码， 命令数据组合起来：结果为F3 E2 42 3A(十六位数据依次写开）

2：从第一个8位数据开始，将其与第二个8位进行异或操作，取得结果。即示例中F3与E2进行异或操作，计算过程如下：
1111 0011（F3)
XOR 1110 0010 (E2)
结果： 0001 0001 (11)

3:将上次计算结果，与第三个8位数据进行异或操作，再次取得结果。即示例中11与42进行异或操作，计算过程如下：
0001 0001 (11)
XOR 0100 0010 (42)
结果： 0101 0011（53)

3：再将上次计算结果，与其后的数据依次进行异或操作，最后就可以得到正确的异或校验结果啦。示例中53与最后一个8位数据3A进行异或操作，计算过程如下：
0101 0011（53)
XOR 0011 1010 (3A)
结果：0110 1001 (69)

4：由以上分析可知，紧接在命令字和数据字后面的异或校验字应为69.

若经过接收方经过异或校验计算出的数据与校验字是相同的，那么此次传送的数据就是有效；反之，接收方计算出的校验字 和 发送方发送过来的校验字是不同的，那本次传送就是错误。

#### 命令类型目录

| 命令模式           | 命令类型 | 描述符        | 命令类型名称 |
| ------------------ | -------- | ------------- | ------------ |
| 输入命令/ 反馈命令 | 0x00     | TYPE_CFG      | 本地配置命令 |
|                    | 0x01     | TYPE_ZDO_REQ  | 网络管理命令 |
|                    | 0x02     | TYPE_ZCL_SEND | ZCL 发送命令 |
| 异步命令           | 0x80     | TYPE_NOTIFY   | 系统通知命令 |
|                    | 0x81     | TYPE_ZDO_RSP  | 网络管理返回 |
|                    | 0x82     | TYPE_ZCL_IND  | ZCL 接收命令 |
|                    | 0x8F     | TYPE_SEND_CNF | 发送确认     |

用单片机串口直连，发送的控制指令都算0x00(本地配置命令)；

#### 命令编码目录  

##### 本地配置命令

| 命令码                       | 描述符           | 命令名称             |
| ---------------------------- | ---------------- | -------------------- |
| 0x00                         | CFG_STATUS       | 查询模组本机当前状态 |
| 0x01 (仅 E72-2G4M20S1E 支持) | CFG_START        | 模组开机/软启动      |
| 0x02                         | CFG_OPEN_NET     | 打开网络/开始组网    |
| 0x03                         | CFG_CLOSE_NET    | 关闭网络/停止组网    |
| 0x04                         | CFG_RESET        | 复位/恢复出厂        |
| 0x05                         | CFG_NODE_TYPE    | 设置本机节点类型     |
| 0x06                         | CFG_CHANNEL      | 查询与设置信道       |
| 0x07                         | CFG_GET_PANID    | 查询 PANID           |
| 0x08                         | CFG_SET_PANID    | 设置 PANID           |
| 0x09                         | CFG_VIEW_GROUP   | 查看本机加组         |
| 0x0A                         | CFG_ADD_GROUP    | 本机加组             |
| 0x0B                         | CFG_REMOVE_GROUP | 本机退组             |
| 仅数传模组支持的命令         |                  |                      |
| 0x10                         | CFG_READ_ATTR    | 读取本地属性参数     |
| 0x11                         | CFG_WRITE_ATTR   | 设置本地属性参数     |
| 0x12                         | CFG_GET_BIND     | 查看常连接目标       |
| 0x13                         | CFG_SET_BIND     | 设置常连接目标       |
| 0x14                         | CFG_FIND_BIND    | 自动常连接           |
| 0x15                         | CFG_POLL         | 终端节点唤醒接收一次 |
| 0x16                         | CFG_AT_MODE      | 进入 AT 模式         |

### 命令无效的反馈

[0x55, 0x03, ‘命令类型’, ‘命令码’, ’校验’]
即命令类型和命令码与输入命令相同， 但不包含任何命令数据的反馈  

输入命令校验不正确则会返回异步命令： 0x55, 0x03, 0xFF, 0xFE, 0x01
输入命令发生断包或者超时则会返回异步命令： 0x55, 0x03, 0xFF, 0xFF, 0x00  

### 用得上的控制指令

以下指令直接复制粘贴用串口发送就行（别忘了是十六进制数，前缀是0x）

查询模组当前状态（读取参数）：55 03 00 00 00

透传模式切换HEX指令模式  ：2B 2B 2B

HEX指令模式切换透传模式：55 07 00 11 00 03 00 01 13

设置PANID（规定PANID为01 01）：55 05 00 08 01 01 08

开始配网 /打开网络：55 04 00 02 00 02

指定发送数据方向（分两次发）：																		55 08 00 11 00 01 00 XX XX ZZ
(设置目标短地址为指定模块的短地址(XX XX)，目标端口为 01，校验码(ZZ))	 55 07 00 11 00 02 00 01 12





### 命令代码编写detail

- 首先肯定是命令格式的正确性
- 其次是要接收反馈（注意是有几毫秒延迟的）命令判断是否成功发送
- 然后就是警惕zigbee模块出现什么突发性故障导致短地址重置，需要偶尔检查短地址



### 休眠模式

作为zigbee uA级低功耗的主力特性，休眠模式一定要能开则开，不然功耗也是mA级（颇高）

## 自定义指令

本套指令格式用于无线传输的数据，应该算是咱项目的私有协议

### 数据帧格式(hex格式)

| 帧头        | 自身长地址              | 命令码(设备类型码) | 有效数据长度 | 有效数据 | 回车  |
| ----------- | ----------------------- | ------------------ | ------------ | -------- | ----- |
| C1 C2 C3 C4 | XX XX XX XX XX XX XX XX | AA                 | YY           | ZZ ZZ……  | 0D 0A |
| 4字节       | 8字节                   | 1字节              | 1字节        | ≥0       | 2字节 |

ps：命令码同时也是设备类型码（除了0x00和0xFF）

### 设备类型码表

| 具体设备中文名 | 对应码十六进制 |
| -------------: | -------------- |
|           电灯 | 0x01           |
|           空调 | 0x02           |
|           窗帘 | 0x03           |
|           门锁 | 0x04           |
|           音响 | 0x05           |
|                |                |
|                |                |
|                |                |
|                |                |



### 设备应答命令0xFF

有效数据内容

| 'O' 'K'(0x4F 0x4B) |
| ------------------ |
| 2字节              |

例：（发出应答设备长地址70 E4 61 25 00 4B 12 00）

C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 FF 02 4F 4B 0D 0A



### 设备信息命令0x00

**有效数据内容**

| 命令源设备类型码 | 短地址 |
| :--------------- | :----- |
| 1字节            | 2字节  |

例：（长地址为17 48 9E 19 00 4B 12 00、短地址为D3 4A）

发送电灯控制器终端的信息：C1 C2 C3 C4	17 48 9E 19 00 4B 12 00	00	03	01	D3 4A	0D 0A



### 电灯控制命令0x01

**有效数据内容**

| 控制命令码 |
| :--------- |
| 1~2字节    |

例：（发出命令设备长地址为70 E4 61 25 00 4B 12 00）

关灯(灯泡断电)：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 01 00 0D 0A

开灯(灯泡上电)：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 01 01 0D 0A

亮度+：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 01 02 0D 0A

亮度-：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 01 03 0D 0A

亮度调至指定档位：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 02 04 XX 0D 0A（XX为档位）(档位为0~11)

进入普通模式：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 01 05 0D 0A

进入呼吸灯模式：C1 C2 C3 C4 70 E4 61 25 00 4B 12 00 01 01 06 0D 0A