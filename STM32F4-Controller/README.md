# 个人任务

以下为个人在项目中负责的任务

## 中控与各电器通信

### 主控向小灯发送无线命令

这里以长地址为17 48 9E 19 00 4B 12 00的E18协调器举例 

1. 使用STM32F4的UART1与zigbee的一个协调器的串口相连，实现MCU对外发送指令和接收外来指令
1. 分析外来指令（这里先只做灯控），并一一执行

### 对串口数据的辨别性接收

- 编写串口1接收中断服务函数

  1. 对发送来的首字节进行判断，
     0x55就认定为Zigbee命令，
     0xC1就认定为自定义数据，
     整合接受到的完整数据，存入USART1_RX_BUF数组中

  2. 接收完后
     判断是Zigbee反馈命令还是Zigbee透传数据
     最后清空USART1_RX_BUF的前两位和USART1_RX_STA，作为串口接收的初始态
- 编写分析Zigbee指令的函数（Zigbee_Analyse_Command_Data）
  1. 分Zigbee模块型号，不同模块型号的反馈命令有点区别
  2. 根据需求写所需反馈命令的判断语句
  3. 判断成立就置1对应的标志位变量（后来测试后发现标志位的方法比较占内存，并且大部分可被while判断语句替代，但while语句在串口中断函数之外，USART1_RX_BUF数组偶尔会出现被频发刷新的bug，还待斟酌最后的方式）

- 编写分析串口透传数据函数

### 对模块的初始化

Zigbee_Init();

- 对协调器
  1. 初始化串口1
  1. 进入配置模式
  1. 打开网络
  1. 进入透传模式
- 对终端 
  1. 初始化串口1
  2. 进入配置模式
  3. 指定透传目标为协调器
  4. 先设置PANID，然后开始配网，再获取PANID检查(此时顺便也读取到了本机的长短地址)是否为01 01
  5. 进入透传模式
  6. 将设备信息命令给协调器，收到协调器的应答才结束初始化函数

## 掉电不丢失

考虑到中控需要对在无线网设备进行统计，并反馈给APP。就需要创建一个数据库**（链表实现）**，存储曾加入过局域网的设备

需求：做到掉电不丢失。
那么可以考虑外置EEPROM——24CXX

这里要强调一下，设计电路的时候一定考虑[掉电瞬间数据存储的情况]([STC单片机EEPROM掉电瞬间的数据保存处理方法 - 控制/MCU - 电子发烧友网 (elecfans.com)](https://www.elecfans.com/emb/danpianji/20181122820021.html))也就是放个大电容

大致计算一下：
u8 = 1byte = 8bit
1个结点12个u8
估计家里有100个Zigbee设备,再加链表表头1个节点
101\*12\*8 = 9696bit = 9.696kbit

AT24C02为 2K bits，只能存21个设备。考虑AT24C16（16K bits）

### 中控对在网设备判定流程

先提一下链表结点的结构体

```c
typedef struct myDevice{
    //数据域
    u8 type;            //电器类型
    u8 OnlineFlag;      //入网标志，0-未入网，1-已入网
    u8 LongAddr[8];     //Zigbee设备长地址
    u8 ShortAddr[2];    //Zigbee设备短地址
    //指针域
    struct myDevice* next;
}Device;
```

1. 中控开机时将将24Cxx中的链表数据load进内存（如果没有那就直接CreateList）√

2. 终端开机时向中控发送自己的设备类型、长地址、短地址，在收到中控应答前不断循环发送 √

3. 中控接收到设备信息命令后先判断该设备是否曾入网，如果链表里有该设备长地址，则更新短地址并标志为已入网 √

   ————————————以上数据都保存在链表中（RAM）————————————————

5. 中控在定时器中需要做：
   - 开机10分钟内，每半分钟，先发送到APP端，再将链表内容save到EEPROM √
   - 开机10分钟后，每当链表更新，先发送到APP端，再将链表内容save到EEPROM√




# 遇到的问题或者一些清奇的思路

- 在测试数据传输格式时，在一个会被不断调用的函数Zigbee_Receive_Data中，不断地 u8* Data 并 Data = (u8*)malloc(sizeof(u8) * (len-4)) 开空间，又没有用free()释放掉，导致空间不足，多调用几次函数之后单片机内存爆满导致Data内存的数据出错

  所以如果会不断使用到malloc，就**一定不要忘记free掉指针！！**
  
- free的时候也是要注意全局的u8* ZBData指向局部的Data后，释放掉局部的Data空间，ZBData等效被释放

- 与zigbee通信的时候一直没有反应，做的第一件事一定是检查判断条件是否正确！！！然后是检查for循环次数是否和命令长度对得上

- 可以写一个用串口发送指定数组的函数

- 高级语言的代码是给人看的，可阅读性怎么高怎么来，程序真的跑起来的时候哪里还是跑我写的“原生”代码，早被编译器优化的杠杠的了

- 发现程序到处都是extern，看的很乱，可以规范下extern的出现位置，就是在哪个.c文件中定义的全局变量，就在该.h文件中extern一下

- printList设备长地址链表的时候到type = 19时出了问题，跟踪代码发现到第19位时type变成了16,第20位甚至变成了0x0b，到第21位程序访问溢出，这里怀疑内存用满了，但不应该，因为STMF4有192KB的片内SRAM